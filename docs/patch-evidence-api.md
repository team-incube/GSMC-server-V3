# 증빙자료 수정 API 동작 구조

## 개요
증빙자료 수정 API는 기존 증빙자료의 정보를 부분적으로 또는 전체적으로 수정할 수 있는 기능을 제공합니다.

## API 명세

### 엔드포인트
```
PATCH /api/v3/evidences/{evidenceId}
```

### 요청 헤더
```json
{
  "Authorization": "Bearer {JWT_ACCESS_TOKEN}"
}
```

### 요청 본문
```json
{
  "participants": [1, 2, 3],  // 선택사항: 참가자 ID 목록 (점수 ID)
  "title": "수정된 증빙자료 제목",  // 선택사항: 증빙자료 제목
  "content": "수정된 증빙자료 내용",  // 선택사항: 증빙자료 내용
  "file_id": [1, 2]  // 선택사항: 파일 ID 목록
}
```

### 응답 본문
```json
{
  "status": "OK",
  "code": 200,
  "message": "OK",
  "data": {
    "id": 1,
    "title": "수정된 증빙자료 제목",
    "content": "수정된 증빙자료 내용",
    "createAt": "2025-10-03T10:30:00",
    "updateAt": "2025-10-03T15:45:00",
    "file": [
      {
        "fileOriginalName": "증빙서류.pdf",
        "fileStoredName": "stored_file_name.pdf",
        "fileUri": "/files/stored_file_name.pdf"
      }
    ]
  }
}
```

## 동작 구조

### 1. 요청 검증 단계
- **증빙자료 존재 여부 확인**: 주어진 evidenceId로 증빙자료가 존재하는지 검증
- **파일 존재 여부 확인**: 요청에 포함된 file_id가 실제 존재하는 파일인지 검증
- **참가자(점수) 존재 여부 확인**: 요청에 포함된 participants(점수 ID)가 실제 존재하는지 검증

### 2. 참가자 연결 업데이트 (선택적)
participants 필드가 제공된 경우:
1. **기존 연결 해제**: 현재 증빙자료와 연결된 모든 점수의 evidenceId를 null로 업데이트
2. **새로운 연결 생성**: 새로운 participants 목록의 점수들과 해당 증빙자료를 연결

### 3. 증빙자료 정보 업데이트
- **부분 업데이트 지원**: null이 아닌 필드만 업데이트하고 나머지는 기존 값 유지
- **파일 연결 업데이트**: 
  - 기존 파일 연결 삭제
  - 새로운 파일 목록과 연결 생성
- **수정 시간 업데이트**: updateAt 필드를 현재 시간으로 업데이트

### 4. 응답 데이터 생성
업데이트된 증빙자료 정보를 조회하여 파일 정보와 함께 응답 데이터 구성

## 데이터베이스 트랜잭션 구조

### 관련 테이블
- **evidence**: 증빙자료 기본 정보 저장
- **score**: 점수 정보 및 증빙자료 연결 정보 저장
- **evidence_file**: 증빙자료와 파일 간의 매핑 정보 저장
- **file**: 파일 메타데이터 저장

### 트랜잭션 흐름
1. **증빙자료 조회**: evidence 테이블에서 기존 데이터 확인
2. **파일 검증**: file 테이블에서 요청된 파일 ID 존재 여부 확인
3. **점수 검증**: score 테이블에서 요청된 점수 ID 존재 여부 확인
4. **점수 연결 업데이트**: score 테이블의 evidenceId 컬럼 업데이트
5. **증빙자료 정보 업데이트**: evidence 테이블 업데이트
6. **파일 연결 업데이트**: evidence_file 테이블에서 기존 연결 삭제 후 새로운 연결 생성
7. **최종 데이터 조회**: 업데이트된 정보를 파일 정보와 함께 조회

## 에러 응답

### 404 Not Found
- **증빙자료 미존재**: 요청된 evidenceId에 해당하는 증빙자료가 없는 경우
- **참가자 미존재**: 요청된 participants에 존재하지 않는 점수 ID가 포함된 경우
- **파일 미존재**: 요청된 file_id에 존재하지 않는 파일 ID가 포함된 경우

### 500 Internal Server Error
- 데이터베이스 트랜잭션 실패
- 서버 내부 오류

## 특징

### 1. 부분 업데이트 지원
- 모든 필드가 선택사항이므로 필요한 부분만 업데이트 가능
- null 값이 전달된 필드는 기존 값 유지

### 2. 원자적 연산
- 모든 업데이트 작업이 하나의 트랜잭션으로 처리되어 데이터 일관성 보장

### 3. 참가자 연결 재설정
- participants가 제공되면 기존 연결을 완전히 대체
- 기존 점수들의 증빙자료 연결이 해제되고 새로운 연결만 생성

### 4. 파일 연결 재설정
- file_id가 제공되면 기존 파일 연결을 완전히 대체
- 기존 파일 연결이 삭제되고 새로운 연결만 생성
